<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="
                     http://www.liquibase.org/xml/ns/dbchangelog
                     http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.23.xsd"
                   logicalFilePath="changelog-master.xml">

  <!--
    NOTA (punto 4):
    Para evitar desalineamientos, abre cada archivo hijo e incorpora
    logicalFilePath en la SU PROPIO <databaseChangeLog> así:

      <databaseChangeLog ... logicalFilePath="changelog/014b-mv-vpp.xml">

    Sugerencias de logicalFilePath por include al final del archivo.
  -->

  <!-- Esquema por defecto (ajusta si usas otro) -->
  <property name="schemaName" value="APP_PYME"/>

  <changeSet id="001-tables" author="sgbd">
    <sqlFile path="../ddl/01_tables.sql" relativeToChangelogFile="true"/>
  </changeSet>

  <changeSet id="002-constraints" author="sgbd">
    <sqlFile path="../ddl/02_constraints.sql" relativeToChangelogFile="true"/>
  </changeSet>

  <!-- 003: índices (un changeSet por índice para permitir preConditions por-ítem) -->

  <changeSet id="003-idx-producto-nombre" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <not>
        <indexExists indexName="IX_PRODUCTO__NOMBRE" schemaName="${schemaName}" tableName="PRODUCTO"/>
      </not>
    </preConditions>
    <createIndex indexName="IX_PRODUCTO__NOMBRE" schemaName="${schemaName}" tableName="PRODUCTO">
      <column name="NOMBRE"/>
    </createIndex>
  </changeSet>

  <changeSet id="003-idx-venta-cliente" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists schemaName="${schemaName}" tableName="VENTA"/>
        <columnExists schemaName="${schemaName}" tableName="VENTA" columnName="CLIENTE_ID"/>
        <not>
          <indexExists schemaName="${schemaName}" tableName="VENTA" indexName="IX_VENTA__CLIENTE_ID"/>
        </not>
      </and>
    </preConditions>
    <createIndex indexName="IX_VENTA__CLIENTE_ID" schemaName="${schemaName}" tableName="VENTA">
      <column name="CLIENTE_ID"/>
    </createIndex>
  </changeSet>

  <changeSet id="003-idx-venta_item-venta" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists schemaName="${schemaName}" tableName="VENTA_ITEM"/>
        <columnExists schemaName="${schemaName}" tableName="VENTA_ITEM" columnName="VENTA_ID"/>
        <not>
          <indexExists schemaName="${schemaName}" tableName="VENTA_ITEM" indexName="IX_VENTA_ITEM__VENTA_ID"/>
        </not>
      </and>
    </preConditions>
    <createIndex indexName="IX_VENTA_ITEM__VENTA_ID" schemaName="${schemaName}" tableName="VENTA_ITEM">
      <column name="VENTA_ID"/>
    </createIndex>
  </changeSet>

  <changeSet id="003-idx-venta_item-producto" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <and>
        <tableExists schemaName="${schemaName}" tableName="VENTA_ITEM"/>
        <columnExists schemaName="${schemaName}" tableName="VENTA_ITEM" columnName="PRODUCTO_ID"/>
        <not>
          <indexExists schemaName="${schemaName}" tableName="VENTA_ITEM" indexName="IX_VENTA_ITEM__PRODUCTO_ID"/>
        </not>
      </and>
    </preConditions>
    <createIndex indexName="IX_VENTA_ITEM__PRODUCTO_ID" schemaName="${schemaName}" tableName="VENTA_ITEM">
      <column name="PRODUCTO_ID"/>
    </createIndex>
  </changeSet>

  <!-- Si en tu 03_indexes.sql hay más índices, los añadimos con el mismo patrón -->

  <changeSet id="004-views" author="sgbd">
    <sqlFile path="../ddl/05_views.sql" relativeToChangelogFile="true"/>
  </changeSet>

  <!-- runOnChange puede reinsertar datos; si prefieres, usa context="demo" y quita runOnChange -->
  <changeSet id="005-seed" author="sgbd" runOnChange="true">
    <sqlFile path="../ddl/06_seed.sql" relativeToChangelogFile="true"/>
  </changeSet>

  <!-- Triggers: suele ser PL/SQL; splitStatements=false correcto -->
  <changeSet id="006-triggers" author="sgbd">
    <sqlFile path="../ddl/07_triggers.sql"
             relativeToChangelogFile="true"
             splitStatements="false"
             endDelimiter="/"/>
  </changeSet>

  <changeSet id="007-ext-tables" author="sgbd" context="dev">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="1">
        SELECT COUNT(*) FROM all_directories WHERE directory_name='IMPORT_DIR'
      </sqlCheck>
    </preConditions>
    <sqlFile path="../ddl/11_external_tables_drop.sql"
             relativeToChangelogFile="true"
             splitStatements="true"
             endDelimiter="/"/>
    <sqlFile path="../ddl/11_external_tables_fix.sql"
             relativeToChangelogFile="true"
             splitStatements="true"/>
  </changeSet>

  <!-- 008a: crear tabla SUCURSAL si no existe -->
  <changeSet id="008a-sucursal-table" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <not><tableExists tableName="SUCURSAL"/></not>
    </preConditions>
    <sql>
      CREATE TABLE sucursal (
        id_sucursal     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
        nombre          VARCHAR2(100) NOT NULL,
        direccion       VARCHAR2(200),
        comuna          VARCHAR2(100),
        ciudad          VARCHAR2(100),
        activo          CHAR(1) DEFAULT 'S' CHECK (activo IN ('S','N')),
        fecha_creacion  TIMESTAMP DEFAULT SYSTIMESTAMP,
        creado_por      VARCHAR2(50) DEFAULT USER,
        CONSTRAINT pk_sucursal PRIMARY KEY (id_sucursal),
        CONSTRAINT uq_sucursal_nombre UNIQUE (nombre)
      )
    </sql>
    <rollback>
      <sql>DROP TABLE sucursal CASCADE CONSTRAINTS PURGE</sql>
    </rollback>
  </changeSet>

  <!-- 008b: añadir columna en INVENTARIO si no existe -->
  <changeSet id="008b-inv-add-col-sucursal" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <not><columnExists tableName="INVENTARIO" columnName="ID_SUCURSAL"/></not>
    </preConditions>
    <sql>ALTER TABLE inventario ADD (id_sucursal NUMBER)</sql>
    <rollback><sql>ALTER TABLE inventario DROP COLUMN id_sucursal</sql></rollback>
  </changeSet>

  <!-- 008c: FK si no existe -->
  <changeSet id="008c-inv-fk-sucursal" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <not><foreignKeyConstraintExists foreignKeyName="FK_INV_SUCURSAL"/></not>
    </preConditions>
    <sql>
      ALTER TABLE inventario
        ADD CONSTRAINT fk_inv_sucursal
        FOREIGN KEY (id_sucursal) REFERENCES sucursal(id_sucursal)
    </sql>
    <rollback><sql>ALTER TABLE inventario DROP CONSTRAINT fk_inv_sucursal</sql></rollback>
  </changeSet>

  <!-- 008d: índice si no existe -->
  <changeSet id="008d-inv-idx-sucursal" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <not><indexExists indexName="IX_INV__SUCURSAL"/></not>
    </preConditions>
    <sql>CREATE INDEX ix_inv__sucursal ON inventario(id_sucursal)</sql>
    <rollback><sql>DROP INDEX ix_inv__sucursal</sql></rollback>
  </changeSet>

  <!-- 008e: seed "Casa Matriz" + asignación -->
  <changeSet id="008e-sucursal-seed" author="sgbd">
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="0">
        SELECT CASE WHEN EXISTS (SELECT 1 FROM sucursal WHERE nombre = 'Casa Matriz') THEN 1 ELSE 0 END FROM dual
      </sqlCheck>
    </preConditions>
    <sql endDelimiter="/" splitStatements="false">
      DECLARE
        v_id NUMBER;
      BEGIN
        INSERT INTO sucursal(nombre, direccion, ciudad)
        VALUES ('Casa Matriz', NULL, 'Santiago')
        RETURNING id_sucursal INTO v_id;

        UPDATE inventario
           SET id_sucursal = v_id
         WHERE id_sucursal IS NULL;
      END;
    </sql>
    <rollback>
      <sql>DELETE FROM inventario WHERE id_sucursal IN (SELECT id_sucursal FROM sucursal WHERE nombre='Casa Matriz')</sql>
      <sql>DELETE FROM sucursal WHERE nombre='Casa Matriz'</sql>
    </rollback>
  </changeSet>

  <changeSet id="012-rut-chile" author="sgbd">
    <sqlFile path="../ddl/12_rut_chile.sql"
             relativeToChangelogFile="true"
             splitStatements="false"
             endDelimiter="/"/>
  </changeSet>

  <changeSet id="013-export-csv" author="sgbd">
    <sqlFile path="../ddl/13_export_csv.sql"
             relativeToChangelogFile="true"
             splitStatements="false"
             endDelimiter="/"/>
  </changeSet>

  <changeSet id="036-demo-seed-vpp" author="sgbd" context="demo">
    <sql splitStatements="false" stripComments="true"><![CDATA[
DECLARE
  v_boleta  NUMBER;
  v_p1      NUMBER;
  v_p2      NUMBER;
  v_numero  NUMBER;
  v_user_id CONSTANT NUMBER := 1;

  v_trg_name        CONSTANT VARCHAR2(30) := 'TRG_BOLETA_SET_USUARIO';
  v_trg_status      VARCHAR2(8);
  v_trg_was_enabled CHAR(1) := 'N';

  FUNCTION has_col(p_tab VARCHAR2, p_col VARCHAR2) RETURN BOOLEAN IS
    v_cnt NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_cnt
      FROM user_tab_cols
     WHERE table_name = UPPER(p_tab)
       AND column_name = UPPER(p_col);
    RETURN v_cnt > 0;
  END;

  FUNCTION next_det_id RETURN NUMBER IS
    v_id  NUMBER;
    v_col VARCHAR2(30);
    v_sql VARCHAR2(200);
  BEGIN
    IF has_col('BOLETA_VENTA_DETALLE','ID_DETALLE') THEN
      v_col := 'ID_DETALLE';
    ELSIF has_col('BOLETA_VENTA_DETALLE','ID_BOLETA_DETALLE') THEN
      v_col := 'ID_BOLETA_DETALLE';
    ELSE
      RETURN NULL; -- no hay columna de ID; el INSERT ya maneja este caso
    END IF;

    v_sql := 'SELECT NVL(MAX('||v_col||'),0)+1 FROM boleta_venta_detalle';
    EXECUTE IMMEDIATE v_sql INTO v_id;
    RETURN v_id;
  END;

  PROCEDURE ensure_prod(
    p_sku VARCHAR2, p_nombre VARCHAR2, p_formato VARCHAR2, p_um VARCHAR2, p_costo NUMBER, p_precio NUMBER
  ) IS
    v_cnt NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_cnt FROM producto WHERE sku = p_sku;
    IF v_cnt = 0 THEN
      INSERT INTO producto (
        sku, nombre, formato, unidad_medida, costo, precio, activo, fecha_creacion, creado_por
      ) VALUES (
        p_sku, p_nombre, p_formato, p_um, p_costo, p_precio, 'S', SYSTIMESTAMP, USER
      );
    END IF;
  END;

  PROCEDURE safe_set_ctx IS
    v_ok NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_ok
      FROM user_objects
     WHERE object_name = 'PKG_APP_CTX'
       AND object_type = 'PACKAGE BODY'
       AND status      = 'VALID';
    IF v_ok > 0 THEN
      BEGIN
        EXECUTE IMMEDIATE 'BEGIN PKG_APP_CTX.SET_ID_USUARIO(1); END;';
      EXCEPTION WHEN OTHERS THEN NULL; END;
    END IF;
  END;

 PROCEDURE insert_det(p_prod NUMBER, p_qty NUMBER, p_price NUMBER, p_desc NUMBER, p_line NUMBER) IS
    v_sql         VARCHAR2(1000);
    v_has_id_det  BOOLEAN := has_col('BOLETA_VENTA_DETALLE','ID_DETALLE');
    v_has_id_bdet BOOLEAN := has_col('BOLETA_VENTA_DETALLE','ID_BOLETA_DETALLE');
    v_has_nline   BOOLEAN := has_col('BOLETA_VENTA_DETALLE','N_LINEA');
    v_has_numline BOOLEAN := has_col('BOLETA_VENTA_DETALLE','NUMERO_LINEA');
    v_id          NUMBER  := next_det_id;
    v_has_line    BOOLEAN := v_has_nline OR v_has_numline;
  BEGIN
    v_sql := 'INSERT INTO boleta_venta_detalle (';

    IF v_has_id_det THEN
      v_sql := v_sql || 'id_detalle,';
    ELSIF v_has_id_bdet THEN
      v_sql := v_sql || 'id_boleta_detalle,';
    END IF;

    v_sql := v_sql || 'id_boleta,id_producto,cantidad,precio_unitario,descuento';

    IF v_has_nline THEN
      v_sql := v_sql || ',n_linea';
    ELSIF v_has_numline THEN
      v_sql := v_sql || ',numero_linea';
    END IF;

    v_sql := v_sql || ') VALUES (';

    IF v_has_id_det OR v_has_id_bdet THEN
      v_sql := v_sql || ':1,';
    END IF;

    v_sql := v_sql || ':2,:3,:4,:5,:6';

    IF v_has_line THEN
      v_sql := v_sql || ',:7';
    END IF;

    v_sql := v_sql || ')';

    IF v_has_id_det OR v_has_id_bdet THEN
      IF v_has_line THEN
        EXECUTE IMMEDIATE v_sql USING v_id, v_boleta, p_prod, p_qty, p_price, p_desc, p_line;
      ELSE
        EXECUTE IMMEDIATE v_sql USING v_id, v_boleta, p_prod, p_qty, p_price, p_desc;
      END IF;
    ELSE
      IF v_has_line THEN
        EXECUTE IMMEDIATE v_sql USING v_boleta, p_prod, p_qty, p_price, p_desc, p_line;
      ELSE
        EXECUTE IMMEDIATE v_sql USING v_boleta, p_prod, p_qty, p_price, p_desc;
      END IF;
    END IF;
  EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN NULL;
  END;

  PROCEDURE crear_boleta IS
  BEGIN
    SELECT SEQ_BOLETA_NUMERO.NEXTVAL INTO v_numero FROM dual;

    INSERT INTO boleta_venta (
      numero, fecha, id_cliente, id_usuario_vende, neto, iva, total, metodo_pago, estado
    ) VALUES (
      v_numero, SYSDATE, NULL, v_user_id, 18000, 3420, 21420, 'EFECTIVO', 'PAGADA'
    ) RETURNING id_boleta INTO v_boleta;

    SELECT id_producto INTO v_p1 FROM producto WHERE sku = 'SKU-11KG';
    SELECT id_producto INTO v_p2 FROM producto WHERE sku = 'SKU-5KG';

    insert_det(v_p1, 1, 12000, 0, 1);
    insert_det(v_p2, 1,  6000, 0, 2);
  END;

BEGIN
  safe_set_ctx;
  ensure_prod('SKU-11KG','Gas 11 kg','11KG','UN',8000,12000);
  ensure_prod('SKU-5KG','Gas 5 kg','5KG','UN',4000, 6000);

  BEGIN
    crear_boleta;
  EXCEPTION
    WHEN OTHERS THEN
      IF SQLCODE IN (-20050, -4088) THEN
        BEGIN
          SELECT status INTO v_trg_status FROM user_triggers WHERE trigger_name = v_trg_name;
          IF v_trg_status = 'ENABLED' THEN
            v_trg_was_enabled := 'Y';
            EXECUTE IMMEDIATE 'ALTER TRIGGER '||v_trg_name||' DISABLE';
          END IF;
        EXCEPTION WHEN NO_DATA_FOUND THEN NULL; END;

        crear_boleta;

        IF v_trg_was_enabled = 'Y' THEN
          BEGIN
            EXECUTE IMMEDIATE 'ALTER TRIGGER '||v_trg_name||' ENABLE';
          EXCEPTION WHEN OTHERS THEN NULL; END;
        END IF;
      ELSE
        RAISE;
      END IF;
  END;

  BEGIN
    DBMS_MVIEW.REFRESH('MV_VENTAS_POR_PRODUCTO','C');
  EXCEPTION WHEN OTHERS THEN NULL; END;
END;
  ]]></sql>
  </changeSet>


  <!-- Includes existentes (cada hijo DEBE declarar su logicalFilePath sugerido) -->
  <!-- En cada archivo incluido, agrega logicalFilePath con el valor sugerido. -->
  <include file="changelog/013-export-dir.xml"                 relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/013-export-dir.xml" -->

  <include file="changelog/014-mv-kpis.xml"                    relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/014-mv-kpis.xml" -->

  <include file="changelog/014b-mv-vpp.xml"                    relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/014b-mv-vpp.xml" -->

  <include file="changelog/015-scheduler-kpis.xml"             relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/015-scheduler-kpis.xml" -->

  <include file="changelog/016-export-procs.xml"               relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/016-export-procs.xml" -->

  <include file="changelog/017-views-kpi.xml"                  relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/017-views-kpi.xml" -->

  <include file="changelog/018-scheduler-export.xml"           relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/018-scheduler-export.xml" -->

  <include file="changelog/019-indexes-perf.xml"               relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/019-indexes-perf.xml" -->

  <include file="changelog/020-monitoring.xml"                 relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/020-monitoring.xml" -->

  <include file="changelog/021-core-ubicaciones-inventario.xml" relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/021-core-ubicaciones-inventario.xml" -->

  <include file="changelog/022-conteos-diarios.xml"            relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/022-conteos-diarios.xml" -->

  <include file="changelog/023-pendientes-vacio.xml"           relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/023-pendientes-vacio.xml" -->

  <include file="changelog/024-compras.xml"                    relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/024-compras.xml" -->

  <include file="changelog/025-ventas-ubicacion.xml"           relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/025-ventas-ubicacion.xml" -->

  <include file="changelog/026-caja-cuentas.xml"               relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/026-caja-cuentas.xml" -->

  <include file="changelog/027-lista-precios.xml"              relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/027-lista-precios.xml" -->

  <include file="changelog/028-geo-clientes.xml"               relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/028-geo-clientes.xml" -->

  <include file="changelog/029-venta-idempotencia.xml"         relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/029-venta-idempotencia.xml" -->

  <include file="changelog/030-app-context.xml"                relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/030-app-context.xml" -->

  <include file="changelog/031-trigger-boleta-usuario.xml"     relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/031-trigger-boleta-usuario.xml" -->

  <include file="changelog/032-seed-precios-producto.xml"      relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/032-seed-precios-producto.xml" -->

  <include file="changelog/034-scheduler-timezone.xml"         relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/034-scheduler-timezone.xml" -->

  <include file="changelog/035-repair-mvs-views.xml"           relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/035-repair-mvs-views.xml" -->

  <include file="changelog/035e-recreate-view-kpi-vpp.xml"     relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/035e-recreate-view-kpi-vpp.xml" -->

  <include file="changelog/036b-demo-seed-cleanup.xml"         relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/036b-demo-seed-cleanup.xml" -->

  <include file="changelog/036c-demo-reseed.xml"               relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/036c-demo-reseed.xml" -->

  <include file="changelog/036d-scheduler-refresh-mvs.xml"     relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/036d-scheduler-refresh-mvs.xml" -->

  <include file="changelog/037-funcs-real.xml"                 relativeToChangelogFile="true"/>
  <!--  Sugerido en hijo: logicalFilePath="changelog/037-funcs-real.xml" -->
  <include file="changelog/038-compile-invalids.xml" relativeToChangelogFile="true"/>

</databaseChangeLog>
